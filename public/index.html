<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="地圖搜尋痞客邦超過10萬篇的食記，任何時候都能找到你想要吃的美食！" />
    <meta name="keywords" content="GeoPixnet,痞客邦找美食,地圖找美食,痞客邦,Taiwan Food,台灣美食,美食,Food,地圖,地圖搜尋,美食地圖,Pixnet" />
    <meta name="author" content="Hua-Ying Tsai" />
    <meta name="contact" content="royal3501@gmail.com"/>
    <meta name="robots" content="index, follow" />
    <meta name="revisit-after" content="5 days" />
    <link rel="shortcut icon" type="image/png" href="favicon.png" />

    <title>痞客邦地圖找美食-GeoPixnet</title>
    <!-- GeoPixnet,地圖找美食,痞客邦找美食 -->

    <script src="https://unpkg.com/react@15.3.2/dist/react.js"></script>
    <script src="https://unpkg.com/react-dom@15.3.2/dist/react-dom.js"></script>
    <script src="https://unpkg.com/babel-core@5.8.38/browser.min.js"></script>
    <script src="https://unpkg.com/jquery@3.1.0/dist/jquery.min.js"></script>
    <script src="javascripts/js.cookie.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDT75Nu6pfJrIHINphMgx7PvZpL55pxSm8"></script>
    <script src="https://cdn.rawgit.com/googlemaps/v3-utility-library/master/infobox/src/infobox_packed.js
"></script>

    <script src="https://fb.me/JSXTransformer-0.13.3.js"></script>

    <link rel="stylesheet" type="text/css" href="semantic.min.css">
    <style>
    html,body {
      height:100%;
    }
    #map {
       width: 40%;
       position: fixed !important;
       bottom: 0;
       left: 0;
       top:40px;
     }
     #list{
       padding:10px;
       margin-left: 40%
     }
    #container {
      height: 100%;
      margin-top: 40px;
    }

    .card-image-cropped {
      height: 175px;
      overflow:hidden;
    }
    .card-image-cropped img {
      width: 100%;
    }

    .small.text{
      font-size:0.9em;
    }

    .ui.card>.content, .ui.cards>.card>.content{
      padding: 0.2em 0.8em;
    }
    .ui.cards>.focus{
      background-color:  #e6f2ff;
    }
    .card h5{
      color: black;
      font-size:1em;
      margin: 0.35em 0;
    }
    </style>
  </head>
  <body>
    <div id="container"></div>
    <script type="text/jsx">
      var map;
      var infowindow;
      var markers = [];

      const MapView = React.createClass({
        mapUpdate: function(){
          resetSelectMarker();
          Cookies.set('map_info',{lat: map.getCenter().lat(),lng:map.getCenter().lng(),zoom:map.getZoom()});
          this.retrieveData();
          $('html, body').animate({
              scrollTop: $("#container").offset().top - 50
          }, 250);
        },
        retrieveData: function(){
          const that = this;
          var bounds = map.getBounds();

          $.ajax({
            url: "./api/",
            dataType: "json",
            data: {
              ne_lat: bounds.getNorthEast().lat(),
              ne_lng: bounds.getNorthEast().lng(),
              sw_lat: bounds.getSouthWest().lat(),
              sw_lng: bounds.getSouthWest().lng()
            },
            success: function(data){
              var lat,lng,coordinates_s,coordinates,id=0;
              that.props.onDataUpdate(data);
              deleteMarkers()

              for(coordinates_s in data){
                coordinates = JSON.parse(coordinates_s);
                lat = coordinates[1];
                lng = coordinates[0];
                addMarker(lat,lng,++id, data[coordinates_s][0]);
              }
            }
          });
        },
        componentDidMount: function(){
          var lat = 25.0468165,lng=121.507962, zoom=16; //Taipei;
          const that = this;
          const map_info = Cookies.getJSON('map_info');
          if(!$.isEmptyObject(map_info)){
            lat = map_info.lat;
            lng = map_info.lng;
            zoom = map_info.zoom;
          }
          map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: lat, lng:lng},
            zoom: zoom
          });
          map.addListener('dragend',this.mapUpdate);
          map.addListener('zoom_changed',this.mapUpdate);
          map.addListener('click',resetSelectMarker);
          google.maps.event.addListenerOnce(map,'bounds_changed', this.mapUpdate);

        },

        render:function(){
          return (
            <div id="map"></div>
          )
        }
      })
      const ListView = React.createClass({
        cardEnter:function(number){
            markers[number-1].setIcon("images/markers1/number_"+number+".png");
            markers[number-1].setZIndex(1000);
        },
        cardLeave:function(number){
            markers[number-1].setIcon("images/markers/number_"+number+".png");
            markers[number-1].setZIndex(1);
        },
        render:function(){
          var data = this.props.data;
          var stores = [];
          var store, article, coordinates;
          var count = 0;
          for(coordinates in this.props.data){
            store = data[coordinates];
            article = store[0];
            stores.push(
              <div className="card" id={"card"+(++count)} key={"card"+count} onMouseEnter={this.cardEnter.bind(this, count)} onMouseLeave={this.cardLeave.bind(this, count)}>
                  <div className="card-image-cropped image">
                    <a href={article.url} target="_blank">
                      <img src={filterImage(article.images)} />
                    </a>
                  </div>
                  <div className="content">
                    <a href={article.url} target="_blank">
                      <h5>{article.title}</h5>
                      <div className="small text description">{article.desc}...</div>
                    </a>
                  </div>
                  <div className="extra content">
                    <div className="right floated meta">{count}</div>
                  </div>
              </div>
            )
          }
          return (
            <div id="list">
              <div className="ten wide column">
                <div className="ui two stackable cards">
                  {stores}
                </div>
              </div>
              <Footer />
            </div>

          )
        }
      })
      const Footer = React.createClass({
        render: function(){
          return (
            <div className="ui vertical footer segment">
              <div className="ui center aligned container">
                <div className = "ui divider"></div>
                  <a href="http://huaying.github.io/" target="_blank"><i className="big child icon"></i></a>
                  <a href="https://www.facebook.com/HuayingTsai" target="_blank"><i className="big facebook f icon"></i></a>
                  <a href="https://github.com/huaying" target="_blank"><i className="big github icon"></i></a>
                  <a href="https://www.linkedin.com/in/huayingtsai" target="_blank"><i className="big linkedin icon"></i></a>
                  <div className = "ui divider"></div>
                  <div className="content">
                    <b>痞客邦地圖找美食 - GeoPixnet</b><br/>
                    <b>Copyright © 2016 Huaying. All Rights Reserved</b>
                  </div>
              </div>
            </div>
          )
        }
      })

      const MainMenu = React.createClass({
        render: function(){
          return (
            <div className="ui fixed main menu">
              <div className="left menu">
                <div className="item">
                  <i className="pointing up icon"></i>
                  <i className="pointing down icon"></i>
                  <i className="pointing right icon"></i>
                  <i className="pointing left icon"></i>
                  <b>痞客邦地圖找美食 - GeoPixnet</b>
                  </div>
              </div>
              <div className="right menu">
                <div className="item">
                <a href="mailto:royal3501@gmail.com" target="_blank"><b>Feedback</b></a>
                </div>
              </div>
            </div>
          )
        }
      })
      const Container = React.createClass({
          getInitialState: function(){
            return {data: []};
          },
          handleDataUpdate: function(data){
            this.setState({data:data})
          },
          render: function(){
            return (
              <div id="container">
                <MainMenu />
                <ListView data={this.state.data}/>
                <MapView onDataUpdate={this.handleDataUpdate}/>
              </div>
            )
          }
      })
      ReactDOM.render(
        <Container />,
        document.getElementById('container')
      );

      function resetSelectMarker(){
        if (infowindow){
          $('.card').removeClass("focus");
          infowindow.close();
        }
      }

      function addMarker(lat,lng,number,article) {
        var marker = new google.maps.Marker({
          position: { lat: lat, lng: lng},
          map: map,
          icon: "images/markers/number_"+number+".png"
        });

        marker.addListener('click',function(){
          resetSelectMarker();
          infowindow = new InfoBox({
            boxStyle: {
                    background: "#FFF"
                    ,width: "240px"
                  },
            pixelOffset: new google.maps.Size(-120, 0),
            content: ['<div class="ui card">',
                          '<div class="card-image-cropped image">',
                              '<img src='+filterImage(article.images)+' />',
                          '</div>',
                          '<div class="content">',
                            '<h5>'+article.title+'</h5>',
                          '</div>',
                        '</div>'
              ].join(""),
            closeBoxURL: "",
          });
          infowindow.open(map,marker)
          $('html, body').animate({
              scrollTop: $("#card"+number).offset().top - 50
          }, 250);
          $("#card"+number).addClass("focus");
        });
        markers.push(marker);
      }
      function showMarkers() {
        setMapOnAll(map);
      }
      function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
          if(map === null) google.maps.event.clearInstanceListeners(markers[i]);
          markers[i].setMap(map);
        }
      }
      function clearMarkers() {
        setMapOnAll(null);
      }
      function deleteMarkers(){
        clearMarkers();
        markers = [];
      }
      function filterImage(images){
        //filter gif
        var i;
        for(i=0;i<images.length;i++){
          if((/\.((?!gif).)*$/).test(images[i])){
            return images[i];
          }
        }
        return 'images/noimage.png';
      }
    </script>
    <script src="semantic.min.js"></script>

  </body>
</html>
