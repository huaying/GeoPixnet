<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="想找附近有什麼好吃的嗎？用地圖搜尋超過10萬篇的痞客邦食記，任何時候都能找到你想要吃的美食！" />
    <meta name="keywords" content="GeoPixnet,地圖美食,痞客邦找美食" />
    <meta name="author" content="Hua-Ying Tsai" />
    <meta name="contact" content="royal3501@gmail.com"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="favicon.png" />

    <title>地圖美食 - GeoPixnet</title>
    <!-- GeoPixnet,地圖找美食,痞客邦找美食 -->

    <script src="https://unpkg.com/react@15.3.2/dist/react.js"></script>
    <script src="https://unpkg.com/react-dom@15.3.2/dist/react-dom.js"></script>
    <script src="https://unpkg.com/jquery@3.1.0/dist/jquery.min.js"></script>
    <script src="javascripts/js.cookie.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCulEP80NpAdvWtp9sq-YZ6w9oqJZJvlCE"></script>
    <script src="https://cdn.rawgit.com/googlemaps/v3-utility-library/master/infobox/src/infobox_packed.js
"></script>

    <script src="https://fb.me/JSXTransformer-0.13.3.js"></script>

    <link rel="stylesheet" type="text/css" href="semantic.min.css">
    <style>
    html,body {
      height:100%;

    }
    #map {
       width: 40%;
       position: fixed !important;
       bottom: 0;
       left: 0;
       top:45px;
       box-shadow: 0 1px 3px 0 #D4D4D5,0 0 0 1px #D4D4D5;
     }
     .refresh_button{
       position: fixed !important;
       top:55px;
       left:10px;
       z-index: 105;
     }

     #list{
       padding:20px;
       margin-left: 40%
     }
    #container {
      height: 100%;
      margin-top: 45px;
    }

    .card-image-cropped {
      height: 175px;
      box-shadow: 0 1px 1px 0 #D4D4D5,0 0 0 1px #D4D4D5;
      background-size: cover !important;
      background-position: center !important;
      display: block !important;
    }

    .small.text{
      font-size:0.9em;
    }

    .ui.cards>.card {
      box-shadow:none;
    }
    .ui.cards>.card>:first-child{
      border-radius: 0 !important;
    }
    .ui.card>.content, .ui.cards>.card>.content{
      padding: 0;
    }
    .ui.cards>.focus{
      background-color:  #e6f2ff;
    }
    .card h5{
      color: black;
      font-size:1em;
      margin: 0.35em 0;
    }

    @media screen and (max-width: 480px) {
      #map {
         width: 100%;
         height: 40%;
       }
       #list{
         margin-left: 0;
         position: relative;
         top: 40%;
       }
     }

     @media screen and (max-aspect-ratio: 1/1){
       #map {
          width: 100%;
          height: 40%;
        }
        #list{
          margin-left: 0;
          position: relative;
          top: 42%;
        }
     }

    </style>
  </head>
  <body>
    <div id="container"></div>
    <script type="text/jsx">
      const IPAD_SIZE = 768;
      var map;
      var infowindow;
      var markers = [];

      const MapView = React.createClass({
        mapUpdate: function(){
          resetSelectMarker();
          Cookies.set('map_info',{lat: map.getCenter().lat(),lng:map.getCenter().lng(),zoom:map.getZoom()});
          this.retrieveData();
          $('html, body').animate({
              scrollTop: $("#container").offset().top - 50
          }, 250);
        },
        retrieveData: function(){
          const that = this;
          var bounds = map.getBounds();


          $('.refresh_button').off('click',this.retrieveData).addClass('loading');
          $.ajax({
            url: "./api/",
            dataType: "json",
            data: {
              ne_lat: bounds.getNorthEast().lat(),
              ne_lng: bounds.getNorthEast().lng(),
              sw_lat: bounds.getSouthWest().lat(),
              sw_lng: bounds.getSouthWest().lng()
            },
            success: function(data){
              var lat,lng,coordinates_s,coordinates,id=0;
              that.props.onDataUpdate(data);
              deleteMarkers()

              for(coordinates_s in data){
                coordinates = JSON.parse(coordinates_s);
                lat = coordinates[1];
                lng = coordinates[0];
                addMarker(lat,lng,++id, data[coordinates_s][0]);
              }
            },
            complete: function(){
              $('.refresh_button').on('click',this.retrieveData).removeClass('loading');
            }
          });
        },
        componentDidMount: function(){
          var lat = 25.0468165,lng=121.507962, zoom=16; //Taipei;
          const that = this;
          const map_info = Cookies.getJSON('map_info');
          if(!$.isEmptyObject(map_info)){
            lat = map_info.lat;
            lng = map_info.lng;
            zoom = map_info.zoom;
          }
          map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: lat, lng:lng},
            zoom: zoom,
            disableDefaultUI: true,
            mapTypeControl: false,
            zoomControl: true,
            streetViewControl:true
          });
          // map.addListener('dragend',this.mapUpdate);
          // map.addListener('zoom_changed',this.mapUpdate);
          map.addListener('click',resetSelectMarker);
          $('.refresh_button').on('click',this.mapUpdate)
          google.maps.event.addListenerOnce(map,'bounds_changed', this.mapUpdate);

        },

        render:function(){
          return (
            <div>
              <button className="ui circular red icon button refresh_button">
                <i className="refresh icon"></i>
              </button>
              <div id="map"></div>
            </div>
          )
        }
      })
      const ListView = React.createClass({
        cardEnter:function(number){
            markers[number-1].setIcon("images/markers1/number_"+number+".png");
            markers[number-1].setZIndex(1000);
        },
        cardLeave:function(number){
            markers[number-1].setIcon("images/markers/number_"+number+".png");
            markers[number-1].setZIndex(1);
        },
        render:function(){
          var data = this.props.data;
          var stores = [];
          var store, article, coordinates;
          var count = 0;
          var imageStyle = "";
          for(coordinates in this.props.data){
            store = data[coordinates];
            article = store[0];
            imageStyle = {
              backgroundImage: 'url('+filterImage(article.images)+')'
            }
            stores.push(
              <div className="card" id={"card"+(++count)} key={"card"+count} onMouseEnter={this.cardEnter.bind(this, count)} onMouseLeave={this.cardLeave.bind(this, count)}>
                  <a href={article.url} target="_blank">
                  <div className="ui card-image-cropped image" style={imageStyle}>
                    <div className="ui yellow ribbon label">
                      {count}
                    </div>
                  </div>
                  </a>
                  <div className="content">
                    <a href={article.url} target="_blank">
                      <h5>{article.title}</h5>
                      <div className="small text description">{article.desc}...</div>
                    </a>
                  </div>

              </div>
            )
          }
          return (
            <div id="list">
              <div className="ten wide column">
                <div className="ui two stackable cards">
                  {stores}
                </div>
              </div>
              <Footer />
            </div>

          )
        }
      })
      const Footer = React.createClass({
        render: function(){
          return (
            <div className="ui vertical footer segment">
              <div className="ui center aligned container">
                <div className = "ui divider"></div>
                  <a href="http://huaying.github.io/" target="_blank"><i className="big child icon"></i></a>
                  <a href="https://www.facebook.com/HuayingTsai" target="_blank"><i className="big facebook f icon"></i></a>
                  <a href="https://github.com/huaying" target="_blank"><i className="big github icon"></i></a>
                  <a href="https://www.linkedin.com/in/huayingtsai" target="_blank"><i className="big linkedin icon"></i></a>
                  <div className = "ui divider"></div>
                  <div className="content">
                    <b>地圖美食 - GeoPixnet</b><br/>
                    <b>Copyright © 2016 Huaying. All Rights Reserved</b>
                  </div>
              </div>
            </div>
          )
        }
      })

      const MainMenu = React.createClass({
        render: function(){
          return (
            <div className="ui inverted blue fixed main menu">
              <div className="left menu">
                <div className="item">
                  <b>
                  <i className="map outline icon"></i>
                  <i className="food icon"></i>
                  地圖美食 - GeoPixnet</b>
                  </div>
              </div>
              <div className="right menu">
                <div className="item">
                <a href="mailto:royal3501@gmail.com" target="_blank"><b>Feedback</b></a>
                </div>
              </div>
            </div>
          )
        }
      })
      const Container = React.createClass({
          getInitialState: function(){
            return {data: []};
          },
          handleDataUpdate: function(data){
            this.setState({data:data})
          },
          render: function(){
            return (
              <div id="container">
                <MainMenu />
                <ListView data={this.state.data}/>
                <MapView onDataUpdate={this.handleDataUpdate}/>
              </div>
            )
          }
      })
      ReactDOM.render(
        <Container />,
        document.getElementById('container')
      );

      function resetSelectMarker(){
        $('.card').removeClass("focus");
        if (infowindow) infowindow.close();
      }

      function addMarker(lat,lng,number,article) {
        var marker = new google.maps.Marker({
          position: { lat: lat, lng: lng},
          map: map,
          icon: "images/markers/number_"+number+".png"
        });

        marker.addListener('click',function(){
          var offset = 0;
          resetSelectMarker();
          if (isMobile()){
            offset = $(window).height() * 0.4;
          }else{
            createInfoBox(article);
            infowindow.open(map,marker)
          }

          $('html, body').animate({
              scrollTop: $("#card"+number).offset().top - 60 - offset
          }, 250);
          $("#card"+number).addClass("focus");
        });
        markers.push(marker);
      }
      function createInfoBox(article){
        infowindow = new InfoBox({
          boxStyle: {
                  background: "#FFF"
                  ,width: "240px"
                },
          pixelOffset: new google.maps.Size(-120, 0),
          content: ['<div class="ui card">',
                        '<div class="card-image-cropped image" style="background-image:url('+filterImage(article.images)+')">',
                        '</div>',
                        '<div class="content">',
                          '<h5>'+article.title+'</h5>',
                        '</div>',
                      '</div>'
            ].join(""),
          closeBoxURL: "",
        });
      }

      function showMarkers() {
        setMapOnAll(map);
      }
      function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
          if(map === null) google.maps.event.clearInstanceListeners(markers[i]);
          markers[i].setMap(map);
        }
      }
      function clearMarkers() {
        setMapOnAll(null);
      }
      function deleteMarkers(){
        clearMarkers();
        markers = [];
      }
      function filterImage(images){
        //filter gif
        var i;
        for(i=0;i<images.length;i++){
          if((/\.((?!gif).)*$/).test(images[i])){
            return images[i];
          }
        }
        return 'images/noimage.png';
      }
      function isMobile(){
        if ($(window).width() / $(window).height() <= 1.0) return true;
        if ($(window).width() <= 480) return true;
        return false;
      }
    </script>
    <script src="semantic.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-39966718-5', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>
